#!/usr/bin/env bash
#vim: sw=2 ts=2 sts=2:

set -e -o pipefail
progname="$(basename $0)"

usage() {
cat <<EOHELP
USAGE:
  $progname [OPTIONS] [PATHS]

OPTIONS:
  PATHS    Directories and files to scan. Default to current.
  -h       Show this help"

DESCRIPTION:

Scan the PATHS for files of interest to CIDB. Artifacts we can collect and
logs, junit results we can parse.
EOHELP
  exit 0
}

while getopts ":hf" opt; do
  case ${opt} in
    h ) usage
      ;;
    f ) FORCE=true
      ;;
    \? ) usage
      ;;
  esac
done
shift $((OPTIND -1))

SCAN_DIR="."
if [ -n "$1" ]; then
  SCAN_DIR="$1"
  shift
fi

if [ ! -d "$SCAN_DIR" ]; then
  echo Scan directory not found: "$SCAN_DIR"
  exit 10
fi

scan() {
  if [ -d cidb ] && [[ $FORCE == true ]]; then
    echo Removing existing scan with force
    rm -rf cidb
  fi
  mkdir cidb
  env > cidb/env.dump
  git rev-parse HEAD > cidb/HEAD

  export CIDB_BUILDER=general
  if [ -f build.xml ]; then
    CIDB_BUILDER=jenkins
  elif [[ -n $JENKINS_HOME ]]; then
    CIDB_BUILDER=jenkins
  elif [[ -n $GITHUB_WORKFLOW ]]; then
    CIDB_BUILDER=github
  fi
  echo Scanning $CIDB_BUILDER build
  echo "$CIDB_BUILDER" > cidb/builder
}

echo Scanning "$SCAN_DIR"
cd "$SCAN_DIR"
scan
