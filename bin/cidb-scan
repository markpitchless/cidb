#!/usr/bin/env bash
#vim: sw=2 ts=2 sts=2:

set -e -o pipefail
progname="$(basename $0)"

usage() {
cat <<EOHELP
USAGE:
  $progname [OPTIONS] [PATHS]

OPTIONS:
  PATHS    Directories and files to scan. Default to current.
  -h       Show this help"

DESCRIPTION:

Scan the PATHS for files of interest to CIDB. Artifacts we can collect and
logs, junit results we can parse.
EOHELP
  exit 0
}

#while getopts ":hk:pt" opt; do
while getopts ":h" opt; do
  case ${opt} in
    h ) usage
      ;;
    #k ) KEY=$OPTARG
    #  ;;
    #t ) TAG_RELEASE=true
    #  ;;
    \? ) usage
      ;;
  esac
done
shift $((OPTIND -1))


scan-jenkins-build-dir() {
  echo foo
}

scan-jenkins-workspace() {
  echo foo
}

scan-github-workflow() {
  echo foo
}

scan-general() {
  echo foo
}

scan-dir() {
  local dir="$1"
  if [[ ! -d $dir ]]; then
    echo Skipping path, not a directory: "$dir"
    return 1
  fi

  echo Scanning "$dir"
  cd "$dir"
  if [ -f build.xml ]; then
    echo Scanning Jenkins build dir
    export CIDB_BUILDER=jenkins
    scan-jenkins-build-dir
  elif [[ -n $JENKINS_HOME ]]; then
    echo Scanning Jenkins workspace
    export CIDB_BUILDER=jenkins
    scan-jenkins-workspace
  elif [[ -n $GITHUB_WORKFLOW ]]; then
    echo Scanning GitHub Actions Workflow
    export CIDB_BUILDER=github
    scan-github-workflow
  else
    echo Scanning general directory
    scan-general
  fi
}

for dir in "$@"; do
  scan-dir "$dir"
done
