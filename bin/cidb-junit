#!/usr/bin/env ruby
#vim: sw=2 ts=2 sts=2:

require 'cidb'

module CIDB
  module JUnit
    class Command
      include CIDB::Sloppy

      banner "USAGE: %{prog} [OPTIONS] [FILES]"

      description <<~EOTXT
        Process junit files for CIDB. Generate CSV files ready for loading.
      EOTXT

      # TODO:
      # def slop(opt)
      #   std_slop # super?
      #   opt.string :csv_dir
      # end

      def main(opts, args)
        files.each { |f| junit f }
      end

      def files
        Enumerator.new do |yielder|
          ARGV << STDIN if @args.empty?
          ARGV.each do |f|
            info "Processing #{f}"
            yielder << f.is_a?(File) ? File.open(f, 'r') : f
          end
        end
      end

      def junit(io)
        csv = CSVWriter.new
        sax = Sax.new csv 
        Ox.sax_parse sax, io
      rescue StandardError => err
        fail! 2, err
      end
    end
  end
end

CIDB::JUnit::Command.new.run
