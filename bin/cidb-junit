#!/usr/bin/env ruby
#vim: sw=2 ts=2 sts=2:

require 'cidb'

module CIDB
  module JUnit
    class Command
      include CIDB::Sloppy

      banner "USAGE: %{prog} [OPTIONS] [FILES]"

      description <<~EOTXT
        Process junit files for CIDB. Generate CSV files ready for loading.
      EOTXT

      def slop(opt)
        opt.string "--csv-suites", "Where to write test suite .csv output",
          default: "suites.csv"
        opt.string "--csv-cases", "Where to write test case .csv output",
          default: "cases.csv"
      end

      def main(opts, args)
        files.each { |f| junit f }
      end

      def files
        Enumerator.new do |yielder|
          if @args.empty?
            yielder << STDIN
          else
            ARGV.each do |f|
              raise "File Not Found: #{f}" unless File.exist? f
              info "Processing #{f}"
              yielder << File.open(f, 'r')
            end
          end
        end
      end

      def junit(io)
        csv = CSVWriter.new(
          suite_file: @opts[:csv_suites],
          case_file:  @opts[:csv_cases]
        )
        sax = Sax.new csv 
        Ox.sax_parse sax, io
      rescue StandardError => err
        fail! 2, err
      end
    end
  end
end

CIDB::JUnit::Command.new.run
